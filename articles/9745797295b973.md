---
title: "BigQueryã§WAUã‚„MAUã‚’æ±‚ã‚ã‚‹" 
emoji: "ğŸ˜¸" 
type: "tech" 
topics: ["bigquery","sql","ãƒ‡ãƒ¼ã‚¿åˆ†æ"] 
published: true 
---

â€»qiitaã‹ã‚‰ã®è»¢è¼‰ã§ã™ã€‚
â€»å…¬é–‹æ—¥ã¯2019å¹´12æœˆ09æ—¥ãªã®ã§å†…å®¹ã«å¤ã„ã¨ã“ã‚ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
https://qiita.com/KogaAkito/items/f9278b87145bbf1e5191

ç’°å¢ƒ
- firebase&BigQueryç’°å¢ƒ
- StandardSQL

DAUã¨ã‹ã¯æ¯”è¼ƒçš„ç°¡å˜ã«æ±‚ã‚ã‚‰ã‚Œã‚‹ã‚ã‚Šã«ã€WAUã¨ã‹MAUãŒåœ°å‘³ã«è€ƒãˆã«ãã‹ã£ãŸï¼†èª¿ã¹ã¦ã‚‚ã‚ã‚“ã¾ã‚Šå‡ºã¦ã“ãªã‹ã£ãŸã®ã§æ›¸ã„ã¦ãŠãã¾ã™ã€‚

firebaseã‚’è¦‹ã‚Œã°ã‚ã‹ã‚‹ã£ã¡ã‚ƒã‚ã‹ã‚‹ã‚“ã§ã™ãŒã€è‡ªåˆ†ã§æ›¸ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ç†è§£ãŒæ·±ã¾ã‚‹ï¼†ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã—ãŸããªã£ãŸã¨ãã«æ‰±ã„ã‚„ã™ã„ã®ã§ã€‚

## ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨
WAU(weekly active user)ã¯ãã®åã®é€šã‚Šã€Œ1é€±é–“ã®ã†ã¡ã«èµ·å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°ã€ã€‚
ä»Šå›ã¯æ¨ç§»ã‚’å‡ºã—ãŸã‹ã£ãŸã®ã§ã€Œã‚ã‚‹æ™‚ç‚¹ã‹ã‚‰éå»1é€±é–“ã®ã†ã¡ã«èµ·å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°ã€ã¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã®WAUã‚’1é€±é–“ã”ã¨ã§ã¯ãªãã€æ—¥ã”ã¨ã®æ¨ç§»(ä»»æ„ã®æ—¥ä»˜ã‹ã‚‰ã•ã‹ã®ã¼ã£ã¦7æ—¥é–“)ã‚’å‡ºã—ãŸã„ã€‚

ã“ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸

|æ—¥ä»˜|wau|
|:----------------:|:------------------:|
| 2019-12-01          |              10,000 |
| 2019-12-02          |            10,500 |
| 2019-12-03          |            11,000 |
| :          |            ï¼š |

MAUã®å ´åˆã‚‚åŒæ§˜

## å®Ÿéš›ã®ã‚¯ã‚¨ãƒª

firebaseã®å®Ÿéš›ã®æ•°å­—ã¨æ¯”ã¹ã¦ã¿ã¾ã—ãŸãŒã€ã»ã¼ã»ã¼åˆã£ã¦ã‚‹æ„Ÿã˜ã ã£ãŸã®ã§ã“ã‚Œã§ã§ãã¦ã‚‹ã®ã§ã¯ã¨æ€ã„ã¾ã™ã€‚(é–“é•ã£ã¦ãŸã‚‰æŒ‡æ‘˜ãã ã•ã„)

```sql
-- æ—¥ã”ã¨ã«èµ·å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’ã¤ãã‚‹
with user_open as (
SELECT 
id
,date(timestamp_micros( event_timestamp ),"Asia/Tokyo") open_date
FROM `ãƒ†ãƒ¼ãƒ–ãƒ«å_*` 
-- éå»35æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã™ã‚‹ï¼ˆå¼Šç¤¾ã®ä»•æ§˜ï¼‰
where _table_suffix between format_date('%Y%m%d', date_sub(current_date("Asia/Tokyo"), interval 35 day)) and format_date('%Y%m%d', date_sub(current_date("Asia/Tokyo"), interval 1 day))
  and event_name = "session_start"
  group by id
,open_date
)

-- é›†è¨ˆã«ä½¿ã†é…åˆ—ã‚’ç”Ÿæˆã™ã‚‹
,date_table as (
select 
date
from 
unnest(GENERATE_DATE_ARRAY(date_sub(current_date("Asia/Tokyo"),interval 28 day),date_sub(current_date("Asia/Tokyo"),interval 1 day))) date
)

-- 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’äº¤å·®çµåˆã™ã‚‹
-- é‚ªé­”ãªè¡Œã‚’whereã§å‰Šã£ã¦ãŠã(å·®ãŒ7æ—¥ä»¥å†…ã«ãªã‚‹ã‚ˆã†ã«çµã‚‹)
,cross_table as (
select id
,open_date
,date
from user_open
cross join date_table
where date_diff(date,open_date,day) < 7
and date_diff(date,open_date,day) >= 0
)

-- dateã§groupã—ã¦idã®å€‹æ•°ã‚’æ•°ãˆã‚Œã°æ¨ç§»ãŒå‡ºã‚‹
select 
date
,count(distinct id) wau
from cross_table
group by date
order by date asc
```
äº¤å·®çµåˆã—ã¦å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ„ã¿åˆã‚ã›ã‚’ä½œã‚Šã€7æ—¥ã®ç¯„å›²ã§ã—ã¼ã£ã¦ã„ãã®ãŒãƒŸã‚½ã§ã™ã€‚
ã“ã‚Œã§æ—¥ä»˜ã®group byã™ã‚Œã°ãã®æ—¥ã‹ã‚‰7æ—¥ä»¥å†…ã«èµ·å‹•ã—ãŸäººæ•°ãŒæ±‚ã¾ã‚Šã¾ã™ã€‚

MAUã®å ´åˆã¯å…ƒãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºæœŸé–“ã‚’ä¼¸ã°ã—ã€å‚ç…§ç¯„å›²ã‚’å¤‰ãˆã‚Œã°åŒæ§˜ã«ã§ãã¾ã™ã€‚
